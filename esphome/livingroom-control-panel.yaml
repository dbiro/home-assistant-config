#### ESPHome devices page: https://devices.esphome.io/devices/Guition-ESP32-S3-4848S040
#### Hardware configuration: https://github.com/agillis/esphome-configs/blob/main/modules/hardware/guition-esp32-s3-4848s040.yaml

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: !secret livingroom_control_panel_encryption_key

ota:
  - platform: esphome
    password: !secret livingroom_control_panel_ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

esphome:
  name: livingroom-control-panel
  friendly_name: Livingroom control panel
  platformio_options:
    board_build.flash_mode: dio

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  flash_size: 16MB
  framework:
    type: esp-idf
    sdkconfig_options:
      COMPILER_OPTIMIZATION_SIZE: y
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: "y"
      CONFIG_ESP32S3_DATA_CACHE_64KB: "y"
      CONFIG_ESP32S3_DATA_CACHE_LINE_64B: "y"
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: y
      CONFIG_SPIRAM_RODATA: y

preferences:
  flash_write_interval: 1min      

psram:
  mode: octal
  speed: 80MHz

#-------------------------------------------
# Internal outputs
#-------------------------------------------
output:
    # Backlight LED
  - platform: ledc
    pin: GPIO38
    id: GPIO38
    frequency: 100Hz

light:
  - platform: monochromatic
    output: GPIO38
    name: Display Backlight
    id: display_backlight
    restore_mode: ALWAYS_ON

#-------------------------------------------
# Touchscreen gt911 i2c
#-------------------------------------------
i2c:
  - id: bus_a
    sda: GPIO19
    scl: GPIO45
    
touchscreen:
  platform: gt911
  transform:
    mirror_x: false
    mirror_y: false
  id: my_touchscreen
  display: my_display

  on_touch:
    - logger.log:
          format: Touch at (%d, %d)
          args: [touch.x, touch.y]
    - lambda: |-
          ESP_LOGI("cal", "x=%d, y=%d, x_raw=%d, y_raw=%0d",
              touch.x,
              touch.y,
              touch.x_raw,
              touch.y_raw
              );    
    - if:
        condition: lvgl.is_paused
        then:
          - lvgl.resume
          - lvgl.widget.redraw

#-------------------------------------------
# Display st7701s spi
#-------------------------------------------
spi:
  - id: lcd_spi
    clk_pin: GPIO48
    mosi_pin: GPIO47
    
display:
  - platform: st7701s
    id: my_display
    update_interval: never
    auto_clear_enabled: False
    spi_mode: MODE3
    data_rate: 2MHz
    color_order: RGB
    invert_colors: False
    dimensions:
      width: 480
      height: 480
    cs_pin: 39
    de_pin: 18
    hsync_pin: 16
    vsync_pin: 17
    pclk_pin: 21
    pclk_frequency: 12MHz
    pclk_inverted: False
    hsync_pulse_width: 8
    hsync_front_porch: 10
    hsync_back_porch: 20
    vsync_pulse_width: 8
    vsync_front_porch: 10
    vsync_back_porch: 10
    init_sequence:
      - 1
      # Custom sequences are an array, first byte is command, the rest are data.
      - [ 0xFF, 0x77, 0x01, 0x00, 0x00, 0x10 ] # CMD2_BKSEL_BK0
      - [ 0xCD, 0x00 ] # disable MDT flag
    data_pins:
      red:
        - 11        #r1
        - 12        #r2
        - 13        #r3
        - 14        #r4
        - 0         #r5
      green:
        - 8         #g0
        - 20        #g1
        - 3         #g2
        - 46        #g3
        - 9         #g4
        - 10        #g5
      blue:
        - 4         #b1
        - 5         #b2
        - 6         #b3
        - 7         #b4
        - 15        #b5
    
#-------------------------------------------
# Sensor configuration
#-------------------------------------------

sensor:
  - platform: wifi_signal
    name: "WiFi Signal"
    id: wifi_signal_db
    update_interval: 60s
    entity_category: diagnostic
    internal: true

  # Reports the WiFi signal strength in %
  - platform: copy
    source_id: wifi_signal_db
    name: "WiFi Strength"
    filters:
      - lambda: return min(max(2 * (x + 100.0), 0.0), 100.0);
    unit_of_measurement: "%"
    entity_category: diagnostic
    internal: true

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "IP Address"
      entity_category: diagnostic
      internal: true
    ssid:
      name: "Connected SSID"
      entity_category: diagnostic
      internal: true
    mac_address:
      name: "Mac Address"
      entity_category: diagnostic
      internal: true

binary_sensor:
  - platform: status
    name: "Status"
    entity_category: diagnostic
    internal: true

#-------------------------------------------
# LVGL Graphics
#-------------------------------------------
lvgl:
  displays:
    - my_display
  touchscreens:
    - my_touchscreen
  bg_color: 0x1c1c1c
  text_color: 0xFFFFFF
  default_font: "montserrat_28"
  on_idle:
    - timeout: 60s
      then:
        - logger.log: "LVGL is idle"
        - lvgl.pause:
            show_snow: true
  pages:
    - id: main_page
      widgets:
        - label:
            align: CENTER
            text: "Hello ESPHome LVGL Graphics!"
